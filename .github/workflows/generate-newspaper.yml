name: Generate Daily AI Newspaper

on:
  schedule:
    # Run every day at 8 AM IST (2:30 AM UTC)
    - cron: '30 2 * * *'
  # Allow manual trigger
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pages: write
      id-token: write
    # Expose secrets as environment variables to steps (case-sensitive)
    env:
      HF_TOKEN: ${{ secrets.HF_TOKEN }}
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
      OPENROUTER_MODEL: ${{ secrets.OPENROUTER_MODEL }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create backend .env from secrets (safe, no values echoed)
        run: |
          mkdir -p backend
          cat > backend/.env << 'EOF'
OPENROUTER_API_KEY=${{ secrets.OPENROUTER_API_KEY }}
OPENROUTER_MODEL=${{ secrets.OPENROUTER_MODEL }}
HF_TOKEN=${{ secrets.HF_TOKEN }}
EOF
          chmod 600 backend/.env

      - name: Verify secrets are present (no values printed)
        run: |
          python - <<'PY'
import os, sys
needed = ["HF_TOKEN","OPENROUTER_API_KEY","OPENROUTER_MODEL"]
missing = [k for k in needed if k not in os.environ or not os.environ[k]]
if missing:
    print("Missing secrets:", ", ".join(missing))
    sys.exit(1)
print("All required secrets are present")
PY

      - name: Generate newspaper
        run: |
          cd backend
          python main.py
        continue-on-error: true

      - name: Copy to docs folder for GitHub Pages
        run: |
          mkdir -p docs
          cp -r output/current/* docs/ || true
          # Ensure images are accessible
          if [ -d "output/images" ]; then
            cp -r output/images docs/
          fi
          # Ensure archive is also accessible via GH Pages
          if [ -d "output/archive" ]; then
            cp -r output/archive docs/
          fi
          cp -f docs/newspaper.html docs/index.html || true

      - name: Commit and push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add -A output/ docs/
          git diff --quiet && git diff --staged --quiet || (git commit -m "Daily newspaper: $(date +'%Y-%m-%d')" && git push)
